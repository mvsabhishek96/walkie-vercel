<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agora Walkie-Talkie</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
</head>
<body>
  <h1>Agora Walkie-Talkie</h1>

  <button id="joinBtn">Join Channel</button>
  <button id="leaveBtn" disabled>Leave Channel</button>
  <button id="pttBtn" disabled>Hold to Talk</button>

  <script>
    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let localAudioTrack;
    let joined = false;

    async function fetchToken() {
      const res = await fetch("/api/generateToken");
      return await res.json();
    }

    document.getElementById("joinBtn").onclick = async () => {
      if (joined) return;

      const { appId, channel, token } = await fetchToken();
      await client.join(appId, channel, token, null);

      // Prepare local mic but don't publish yet
      localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();

      document.getElementById("joinBtn").disabled = true;
      document.getElementById("leaveBtn").disabled = false;
      document.getElementById("pttBtn").disabled = false;
      joined = true;

      client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        if (mediaType === "audio") {
          user.audioTrack.play();
        }
      });

      client.on("user-unpublished", (user) => {
        console.log("User left:", user.uid);
      });
    };

    document.getElementById("leaveBtn").onclick = async () => {
      if (!joined) return;

      if (localAudioTrack) {
        localAudioTrack.stop();
        localAudioTrack.close();
      }

      await client.leave();
      document.getElementById("joinBtn").disabled = false;
      document.getElementById("leaveBtn").disabled = true;
      document.getElementById("pttBtn").disabled = true;
      joined = false;
    };

    // Push-to-Talk button
    const pttBtn = document.getElementById("pttBtn");
    pttBtn.onmousedown = async () => {
      if (joined && localAudioTrack) {
        await client.publish([localAudioTrack]);
        console.log("ðŸŽ™ï¸ Mic ON");
      }
    };
    pttBtn.onmouseup = async () => {
      if (joined && localAudioTrack) {
        await client.unpublish([localAudioTrack]);
        console.log("ðŸ”‡ Mic OFF");
      }
    };
  </script>
</body>
</html>

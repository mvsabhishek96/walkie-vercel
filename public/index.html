<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Walkie-Talkie</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
</head>
<body>
  <h1>Agora Walkie-Talkie</h1>

  <input id="channel" placeholder="Channel Name" />
  <button id="joinBtn">Join Channel</button>
  <button id="leaveBtn">Leave Channel</button>

  <div class="ptt-container">
    <button id="pttBtn">Hold to Talk</button>
  </div>

  <script>
    const APP_ID = "59595697a95d4d819dda18070b4f5ffe"; 
    let client, localTrack;

    document.getElementById("joinBtn").onclick = async () => {
      const channel = document.getElementById("channel").value || "default";
      const res = await fetch(`/api/generateToken?channel=${channel}`);
      const data = await res.json();

      client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
      await client.join(APP_ID, channel, data.token, data.uid);

      localTrack = await AgoraRTC.createMicrophoneAudioTrack();
      await client.publish([localTrack]);

      client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        if (mediaType === "audio") user.audioTrack.play();
      });

      console.log("Joined:", channel);
    };

    document.getElementById("leaveBtn").onclick = async () => {
      if (localTrack) localTrack.close();
      if (client) await client.leave();
      console.log("Left channel");
    };

    const pttBtn = document.getElementById("pttBtn");
    pttBtn.addEventListener("mousedown", async () => {
      if (localTrack) await localTrack.setEnabled(true);
    });
    pttBtn.addEventListener("mouseup", async () => {
      if (localTrack) await localTrack.setEnabled(false);
    });
    pttBtn.addEventListener("touchstart", async () => {
      if (localTrack) await localTrack.setEnabled(true);
    });
    pttBtn.addEventListener("touchend", async () => {
      if (localTrack) await localTrack.setEnabled(false);
    });
  </script>
</body>
</html>
